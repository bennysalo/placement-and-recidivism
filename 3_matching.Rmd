---
title: "Matching"
output: html_notebook
date: 2018-02-12
---

```{r}
library(MatchIt)
library(stringr)
sessionInfo()

```

Key for abbreviations:

op = Open Placement
cr = Conditional Release
ps = Parole Supervised

0 = no, 1 = yes




Write a function for matching. This function takes the following arguments:
+ 'subset_data' - A data frame. The subset previously generated that only includes individuals who have gotten the same treatment except for the effect variable. 
+ 'effect_variable' - A character string. The name of the variable that constitutes the independent variable in later analysis. The matching should thus produce two groups that are blananced on every covariate except this variable.
+ 'blancing_variables' - A vector of character stings. The names of all the variables that serve as covariates. The default is a previously defined vector 'all_predictors'.


```{r}

my_matching <- function(subset_data, effect_variable, balancing_variables = all_predictors, ...) {
  require(MatchIt)
  
  # Intitate a list of results that will be returned
   out <- list(effect_variable = effect_variable, data = subset_data, match = NA)

  # Write the formulas that will be needed
  # Matching formulas. Here the other exactly matched variables are not included as predictors.
   
  write_formula <- function(outcome = dicotom_var) {
    as.formula(paste(outcome, " ~ ", paste(balancing_variables, collapse = " + "))) 
  } 

   
  # Write corresponding formula that will be used with 'matchit'
  # Different formulas depending on what the effect_variable is
  if        (effect_variable == "openPrison") {
    dichotom_var <- "open01"
    matching_formula <- write_formula("open01")
    
  } else if (effect_variable == "conditionalReleaseGranted") {
    dichotom_var <- "cond01"
    matching_formula <- write_formula("cond01")

  } else {
    warning("Could not determine effect")
  }
  
  
 # Do matching with prespecified parameters
   
   # Exclude irrelevant variables with missing values. 
   # Matchit does not allow missing values. 
   # All included predictors are complete data. Matchit will not run if a
      # used predictor is excluded.
   
   index_no_missing <- apply(included_sample, MARGIN = 2, FUN = anyNA) == FALSE
   no_missing_vars <- names(included_sample)[index_no_missing]
  
  out$match <- matchit(formula = matching_formula,
                       data    = subset_data[no_missing_vars], 
                       method  = "nearest", discard = "both",
                       distance = "logit", caliper = 0.25, ratio = 1)
  
  out$data$matched <- out$match$weights
  out$data$matched_f <- factor(out$data$matched, levels = c(1,0), 
                             labels = c("Matched", "Unmatched"))
    
  # Function to get category
  # Right now this is not needed (2018-02-19)
  get_category <- function(match_variable, effect_variable){
    m <- match_variable
    e <- effect_variable
    ifelse                      (m == 1 & e == 0, "matched_0",
            ifelse              (m == 1 & e == 1, "matched_1", 
                   ifelse       (m == 0 & e == 0, "unmatched_0",
                          ifelse(m == 0 & e == 1, "unmatched_1",
                                 NA))))
  }
   
  # Add a category variable   
  out$data$category <- get_category(match_variable  = out$data$matched,
                                    effect_variable = out$data[[dichotom_var]])

  return(out)
}



```


# Do the matching for each subset.

```{r}
op_cr0_ps0 <-  my_matching(subset_cr0_ps0, "openPrison")
op_cr0_ps1 <-  my_matching(subset_cr0_ps1, "openPrison")
 
cr_op1_ps0 <-  my_matching(subset_op1_ps0, "conditionalReleaseGranted")
cr_op1_ps1 <-  my_matching(subset_op1_ps1, "conditionalReleaseGranted")
  
```

Checks
```{r}
do_checks_I_want <- function(my_matching_output) {
  
  matchit_object <- my_matching_output$match
  matchit_object
  plot(matchit_object, type = "jitter")
  plot(summary(matchit_object, standardize = TRUE))
}
```

```{r}
do_checks_I_want(op_cr0_ps0)
```

```{r}
do_checks_I_want(op_cr0_ps1)
```

```{r}
do_checks_I_want(cr_op1_ps0)
```

```{r}
do_checks_I_want(cr_op1_ps1)
```



