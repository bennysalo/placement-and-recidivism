---
title: "Analyses and figures"
output: html_notebook
date: 2018-01-22
---

In this part of the analyses we do the logistic regression analyses and plot the results.

# Function for logistic regressions

Here we write a function that takes the list of results previously compiled (data and matching results) and adds logistic regression results. We perform two logistic regression analyses:
1. An ancova style analysis with the effect of the independent variable controlled by the propensity score
2. Extending this with an interaction effect to test the assumption of "parallel lines".

Estimated probabilities from 2) will be used in the plots. 

```{r}

add_glm_tests <- function(results_list) {
  if (results_list$effect_variable == "openPrison") {         # open placement
    f_ancova      <- "reoffenceThisTerm ~ openPrison + propensity_open_logit"
    f_interaction <- "reoffenceThisTerm ~ openPrison * propensity_open_logit"
    
  } else if (results_list$effect_variable == "conditionalReleaseGranted"){         # conditional release
    f_ancova      <- "reoffenceThisTerm ~ conditionalReleaseGranted + propensity_cond_logit"
    f_interaction <- "reoffenceThisTerm ~ conditionalReleaseGranted * propensity_cond_logit"
    
  } else {
    warning('Could not specificy effect')
  }
  
  used_data <- results_list$data[results_list$data$matched == 1, ]
  
  results_list$glm_ancova      <- glm(f_ancova,      
                                          family = binomial, data = used_data)
  results_list$glm_interaction <- glm(f_interaction, 
                                          family = binomial, data = used_data)

  return(results_list)
}


```

Use this function on the results lists.

```{r}
op_cr0_ps0 <- add_glm_tests(op_cr0_ps0)
op_cr0_ps1 <- add_glm_tests(op_cr0_ps1)

cr_op1_ps0 <- add_glm_tests(cr_op1_ps0)
cr_op1_ps1 <- add_glm_tests(cr_op1_ps1)

```

Write a function to get the chi-square value for the models and associated p-values

```{r}
get_chi_stats <- function(glm_model) {
  d_chisq = glm_model$null.deviance - glm_model$deviance
  d_df    = glm_model$df.null       - glm_model$df.residual
  p       = 1 - pchisq(q = dchisq, df = ddf)
  data_frame(d_chisq, d_df, p)
}
```


Results for the effect of placement in open prison
- in combination with no conditional release
- among individuals NOT SUPERVISED during parole

No main effect. Adding interaction term is not a statistically significant improvement.

```{r}
summary      (op_cr0_ps0$glm_ancova)
get_chi_stats(op_cr0_ps0$glm_ancova)

summary      (op_cr0_ps0$glm_interaction)
get_chi_stats(op_cr0_ps0$glm_interaction)

anova(op_cr0_ps0$glm_ancova, op_cr0_ps0$glm_interaction, test = "Chisq")

```

Results for the effect of placement in open prison
- in combination with no conditional release
- among individuals SUPERVISED during parole

No main effect. Adding interaction term is not a statistically significant improvement.
```{r}
summary(op_cr0_ps1$glm_ancova)
get_chi_stats(op_cr0_ps1$glm_ancova)

summary(op_cr0_ps0$glm_interaction)
get_chi_stats(op_cr0_ps0$glm_interaction)

anova(op_cr0_ps0$glm_ancova, op_cr0_ps0$glm_interaction, test = "Chisq")

```


We aggregate the logistic regression coefficients for the independent variable from the two ANCOVA-style analyses. We do this with a random effects meta-analysis of two effects. We are thus examining the mean effect over supervised and non-supervised individuals.

```{r}
library(metafor)

coefs_open_prison <- 
  rbind(
  summary(op_cr0_ps0$glm_ancova)$coefficients["openPrisonopen_prison", 1:2],
  summary(op_cr0_ps1$glm_ancova)$coefficients["openPrisonopen_prison", 1:2]
) 

rma(yi = coefs_open_prison[,1], sei = coefs_open_prison[,2], measure = "OR")


```
```{r}
coefs_cr <- 
  rbind(
  summary(cr_op1_ps0$glm_ancova)$coefficients["conditionalReleaseGranted.L", 1:2],
  summary(cr_op1_ps1$glm_ancova)$coefficients["conditionalReleaseGranted.L", 1:2]
) 

rma(yi = coefs_cr[,1], sei = coefs_cr[,2], measure = "OR")



```


